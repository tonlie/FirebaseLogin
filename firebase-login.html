<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../firebase-element/firebase-auth.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<!--
Firebase E-Mail&Password functionality
-->
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../gold-email-input/gold-email-input.html">
<link rel="import" href="../paper-input/paper-input.html">

<!--
An element that creates a login menu for firebase.
Includes a `<paper-menu-button>`, encapsulating a `<firebase-auth>` element and
some additional functionality regarding Firebase's own e-mail and password based
login provider.
Built to work extra great in `<paper-header-panel>`'s.

Example:
```html
<firebase-login
auto-login
redirect
google
mail-pass
firebase-url='https://<YOUR-FIREBASE-APP>.firebaseio.com'>
</firebase-login>
```
@demo demo/index.html
-->

<dom-module id="firebase-login">
  <template>
  <style is="custom-style">
  :host {
    display: block;
    box-sizing: border-box;
    font-family: Roboto, sans-serif;

    --paper-dialog-button-color: #448AFF;
    --paper-dialog: {
      background-color: #FFF;
    };

    --paper-tabs: {
      background-color: #448AFF;
      color: #FFF;
      margin-top: 0px;
      margin-bottom: 0px;
    };
  }
  :host paper-item {
    display: block;
    font-size: 10pt;
    color: #333;
    padding: 5px;
    cursor: pointer;
  }
  :host paper-item:hover {
    background: #448AFF;
    color: #FFF;
  }
  :host paper-button {
    cursor:pointer;
  }
  :host paper-menu {
    display: block;
  }
  :host paper-menu-button {
    /*margin: 2px;*/
    padding: 0px;
    background: #448AFF;
    color: #FFF;
  }
  :host > .paper-dialog-0 > * {
    margin-top: 0px;
    padding: 0px;
  };
  .success {
    background-color: #4CAF50;
  }
  .error {
    background-color: #FF5252;
  }
  </style>

  <firebase-auth
  id="baseLogin"
  user={{user}}
  statusKnown={{statusKnown}}
  location="[[firebaseUrl]]"
  provider="[[firebaseProvider]]"
  on-error="onFirebaseError"
  on-login="onFirebaseLogin">
  </firebase-auth>

  <paper-menu-button
  id="menuButton"
  horizontal-align="left"
  vertical-align="bottom"
  vertical-offset="-5">
    <paper-button class="dropdown-trigger">
      <iron-icon icon="icons:account-circle"></iron-icon>
      [[userName]]
    </paper-button>
    <paper-menu class="dropdown-content">
      <paper-item id="loginMenuFacebook" on-click="login" hidden$="[[statusKnown]]">Login with Facebook</paper-item>
      <paper-item id="loginMenuGoogle" on-click="login" hidden$="[[statusKnown]]">Login with Google</paper-item>
      <paper-item id="loginMenuGithub" on-click="login" hidden$="[[statusKnown]]">Login with Github</paper-item>
      <paper-item id="loginMenuTwitter" on-click="login" hidden$="[[statusKnown]]">Login with Twitter</paper-item>
      <paper-item id="loginMenuEmailPass" on-click="openLoginPassDiag" hidden$="[[statusKnown]]">Login with E-Mail&Password</paper-item>
      <paper-item id="loginMenuLogout" on-click="logout" hidden$="[[!statusKnown]]">Logout</paper-item>
    </paper-menu>
  </paper-menu-button>

  <!--
  Firebase Login & Password
  -->
  <paper-dialog id="loginPassDialog">
    <!-- <h2>Login/Register account</h2> -->
    <paper-tabs selected="{{loginPassDiagSelected}}">
      <paper-tab>Login</paper-tab>
      <paper-tab>Register</paper-tab>
    </paper-tabs>
    <paper-dialog-scrollable>
      <iron-pages selected="{{loginPassDiagSelected}}">
        <section id="divLogin">
          <gold-email-input id="inputLoginEmail" value="abc@example.com" label="E-Mail" required auto-validate></gold-email-input>
          <paper-input id="inputLoginPass" label="Password" type="password" required auto-validate error-message="Empty input!"></paper-input>
          <div class="buttons">
            <paper-button dialog-confirm autofocus on-click="mailPassLogin">Login</paper-button>
            <paper-button dialog-dismiss>Close</paper-button>
          </div>
          <div class="buttons">
            <paper-button on-click="mailPassForgotPW">Forgot Password</paper-button>
          </div>
        </section>
        <section id="divRegister">
          <gold-email-input id="inputRegEmail" value="abc@example.com" label="E-Mail" required auto-validate></gold-email-input>
          <paper-input id="inputRegPass" value="abc" label="Password" type="password" required auto-validate error-message="Empty input!"></paper-input>
          <div class="buttons">
            <paper-button dialog-confirm autofocus on-click="mailPassRegister">Register</paper-button>
            <paper-button dialog-dismiss>Close</paper-button>
          </div>
        </section>
      </iron-pages>
    </paper-dialog-scrollable>
  </paper-dialog>

  <!-- Reset password dialog -->
  <paper-dialog id="resetPassDialog" modal>
    <h3>Reset password</h3>
    <paper-dialog-scrollable>
      <paper-input id="oldPassInput" label="Old password" type="password" required auto-validate error-message="Empty input!"></paper-input>
      <paper-input id="newPassInput" label="New password" type="password" required auto-validate error-message="Empty input!"></paper-input>
      <div class="buttons">
        <paper-button dialog-confirm autofocus on-click="mailPassReset">Save</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog-scrollable>
  </paper-dialog>

  <!-- toast messages -->
  <paper-toast id="toastLoggedIn" class="success" text="Logged in!"></paper-toast>
  <paper-toast id="toastLoggedOut" class="success" text="Logged out!"></paper-toast>
  <paper-toast id="toastLoggedInError" class="error" text="Login failed!"></paper-toast>
  <paper-toast id="toastUserCreated" class="success" text="User created successfully!"></paper-toast>
  <paper-toast id="toastUserCreatedError" class="error"text="Error creating user!"></paper-toast>
  <paper-toast id="toastMailSent" class="success" text="Password reset mail sent!"></paper-toast>
  <paper-toast id="toastMailSentError" class="error" text="Password reset mail NOT sent!"></paper-toast>
  <paper-toast id="toastPassReset" class="success" text="Password reset successfull!"></paper-toast>
  <paper-toast id="toastPassResetError" class="error" text="Password reset failed!"></paper-toast>
  </template>

  <script>
  Polymer({
    is: 'firebase-login',

    properties: {
      /**
      * `google` enables google authentication provider
      */
      google: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
      * `github` enables github authentication provider
      */
      github: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
      * `facebook` enables facebook authentication provider
      */
      facebook: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
      * `twitter` enables twitter authentication provider
      */
      twitter: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
      * `mailPass` enables firebases own e-mail & password provider
      */
      mailPass: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
      * `statusKnown` determines, whether there is a user logged in
      */
      statusKnown: {
        type: Boolean,
        value: false,
        notifiy: true
      },
      /**
      * `firebaseUrl` contains the URL to the firebase instance
      */
      firebaseUrl: String,

      /**
      * Firebase reference object
      */
      firebaseRef: Object,

      /**
      * Should login try redirect, see firebase-element
      */
      redirect: {
        type: Boolean,
        value: false
      },

      /**
      * Activate automatic login, see firebase-element
      */
      autoLogin: {
        type: Boolean,
        value: false
      }
    },

    // Element Lifecycle
    ready: function() {
      // set options for basic firebase login
      if(this.autoLogin)
        this.$.baseLogin.autoLogin = true;
      if(this.redirect)
        this.$.baseLogin.redirect = true;

      // Set basic username a.k.a. Login-Button text
      if(!this.statusKnown)
        this.userName = "Login";

      this.checkMenueItemsAndUsername();

      // set Login tab as standard
      this.loginPassDiagSelected = 0;
    },

    // Element Behavior
    /**
    * Convenience login function.
    */
    login: function(event) {
      this.$.menuButton.close();

      if(event.srcElement.id.includes("Google"))
      {
        this.firebaseProvider = 'google';
      }
      else if (event.srcElement.id.includes("Github"))
      {
        this.firebaseProvider = 'github';
      }
      else if (event.srcElement.id.includes("Facebook"))
      {
        this.firebaseProvider = 'facebook';
      }
      else if (event.srcElement.id.includes("Twitter"))
      {
        this.firebaseProvider = 'twitter';
      }
      else {
        // last resort/fallback
        this.firebaseProvider = 'google';
      }

      this.$.baseLogin.login();
    },

    /**
    * Function called, when Firebase-Auth logged in succesfully.
    * Calls convenience functions and sets up firebase reference.
    */
    onFirebaseLogin: function(event) {
      // set statusKnown again, so hiding Login/Logout button works
      // seems like, it is set after the buttons are drawn on init
      this.statusKnown = true;
      // set correct username
      this.checkMenueItemsAndUsername();
      this.firebaseRef = new Firebase(this.firebaseUrl + '/user/' + event.detail.user.uid);
      document.getElementById("toastLoggedIn").open();
    },

    /**
    * Logout function calls Firebase-Auth and convenience functions
    * regarding the login menue and the username.
    */
    logout: function() {
      this.$.menuButton.close();
      this.$.baseLogin.logout();

      this.statusKnown = false;
      this.checkMenueItemsAndUsername();
      document.getElementById("toastLoggedOut").open();
    },

    /**
    * If connection to Firebase fails, show error toast
    */
    onFirebaseError: function(event) {
      document.getElementById('toastLoggedInError').text('Login failed! ' + event.detail.message);
      document.getElementById('toastLoggedInError').open();
    },

    /**
    * Hides unused login types from login menu
    *
    * Additionally used to adjust Username/Login/Logout String
    * on the button.
    */
    checkMenueItemsAndUsername: function() {
      // hide deactivated login methods
      if(!this.statusKnown) {
        if(!this.facebook && document.getElementById('loginMenuFacebook') != null)
          document.getElementById('loginMenuFacebook').setAttribute('hidden', true);
        if(!this.google && document.getElementById('loginMenuGoogle') != null)
          document.getElementById('loginMenuGoogle').setAttribute('hidden', true);
        if(!this.twitter && document.getElementById('loginMenuTwitter') != null)
          document.getElementById('loginMenuTwitter').setAttribute('hidden', true);
        if(!this.github && document.getElementById('loginMenuGithub') != null)
          document.getElementById('loginMenuGithub').setAttribute('hidden', true);
        if(!this.mailPass && document.getElementById('loginMenuEmailPass') != null)
          document.getElementById('loginMenuEmailPass').setAttribute('hidden', true);
      }

      // name functionality
      if(this.user) {
        switch (this.user.provider) {
          case 'facebook':
            this.userName = this.user.facebook.displayName;
          break;
          case 'google':
            this.userName = this.user.google.displayName;
          break;
          case 'github':
            this.userName = this.user.github.username;
          break;
          case 'password':
            this.userName = this.user.password.email.split("@")[0];
          break;
          // TODO determine twitter username
          default:
            this.userName = 'default';
        }
      }
      else
        this.userName = "Login";
    },

    /**
    * Function for LoginPassDiag
    */
    openLoginPassDiag: function() {
      this.$.menuButton.close();

      this.firebaseProvider = "password";
      this.$.loginPassDialog.open();
    },

    /**
    * Login function for firebases mail & password provider
    */
    mailPassLogin: function() {
      if(this.$.inputLoginEmail.validate() &&
      this.$.inputLoginPass.value.length > 0) {
        if(!this.firebaseRef)
          this.firebaseRef = new Firebase(this.firebaseUrl);

        this.firebaseRef.authWithPassword({
          email: this.$.inputLoginEmail.value,
          password: this.$.inputLoginPass.value
        }, function(error, authData) {
          if(error) {
            document.getElementById("toastLoggedInError").open();
          } else {
            // if temporary password, make user chosse a new one
            if(authData.password.isTemporaryPassword) {
              document.getElementById("resetPassDialog").open();
            }
          }
        });
      }
    },

    /**
    * Function to send password-forgot-mail
    */
    mailPassForgotPW: function() {
      if(this.$.inputRegEmail.validate()) {
        if(!this.firebaseRef)
          this.firebaseRef = new Firebase(this.firebaseUrl);

        this.firebaseRef.resetPassword({
          email: this.$.inputRegEmail.value
        }, function(error) {
          if(error) {
            document.getElementById("toastMailSentError").open();
          } else {
            document.getElementById("toastMailSent").open();
          }
        });
      }
    },

    /**
    * Function to register a user for firebase mail & passwort provider
    */
    mailPassRegister: function() {
      if(this.$.inputRegEmail.validate() &&
      this.$.inputRegPass.value.length > 0) {
        if(!this.firebaseRef)
          this.firebaseRef = new Firebase(this.firebaseURL);

        this.firebaseRef.createUser({
          email: this.$.inputRegEmail.value,
          password: this.$.inputRegPass.value
        }, function(error, userData) {
          if(error) {
            document.getElementById("toastUserCreatedError").open();
          } else {
            document.getElementById("toastUserCreated").open();
          }
        });
      }
    },

    /**
    * Function to reset the password
    */
    mailPassReset: function() {
      if(this.$.oldPassInput.value.length > 0 &&
         this.$.newPassInput.value.length > 0) {

          this.firebaseRef.changePassword({
            email: this.user.password.email,
            oldPassword: this.$.oldPassInput.value,
            newPassword: this.$.newPassInput.value
          }, function(error) {
            if(error) {
              document.getElementById("toastPassResetError").open();
            } else {
              document.getElementById("toastPassReset").open();
            }
          });
        }
      }
    });
  </script>
</dom-module>
